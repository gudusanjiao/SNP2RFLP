# Workflow of using VCF-kit to design primers related to polymorphic restriction site in vcf files
Nan Hu / 
Nov. 22, 2020

---

## Installation and environment settings for VCF-kit (important)
To prepare for installing VCF-kit, make sure system has pip and anaconda installed ahead. 
If new users do not have these two tools installed, you can refer to [pip installing guide](https://pip.pypa.io/en/stable/installing/) 
and [anaconda installing guide](https://docs.anaconda.com/anaconda/install/linux/) to get instructions for installation. Once required tools are prepared, 
execute below commands in commandline:
```bash
conda config --add channels bioconda
conda config --add channels conda-forge
conda create -n vcf-kit \
  danielecook::vcf-kit=0.2.6 \
  "bwa>=0.7.17" \
  "samtools>=1.10" \
  "bcftools>=1.10" \
  "blast>=2.2.31" \
  "muscle>=3.8.31" \
  "primer3>=2.5.0"
```
These process a virtual enviroment only for VCF-kit. We can activate this enviroment by:
```bash
conda activate vcf-kit
```
Since this software have not been updated for several years, there are some python codes not accommodating new biopython package. 
We need to install old versions of biopython and fix some issues there.
```bash
# uninstall new version of biopython
conda uninstall biopython
# install v1.77 biopython
conda install biopython=1.77
# uninstall numpy thoroughtly, repeat this step until there is nothing to uninstall
conda uninstall numpy
# re-install numpy
conda install numpy
```
Check the availability of VCF-kit with our expected function by:
```bash
vk primer --help
```
Last step to prepare the environment is to fix some coding issue in finding primer3 software. 
VCF-kit expected we installed Primer3 under system folder so by default it will search primer3-config files in some of these folders.
We need to find where our primer3-config files are and manually add to the searching range.
```bash
find ~ -iname primer3_config -type d
```
There will be a result at ```~/anaconda3/lib/python3.6/site-packages/vcfkit/static/primer3_config```. Save this path and do another search:
```bash
find ~ -iname primer3.py -type f
```
> Noticed here, it is possible that you cannot find this config file due to new primer3 version. If so, you can use path of mine: ```/home/nan/anaconda3/lib/python3.6/site-packages/vcfkit/static/primer3_config```. I did not see any errors by using others config file right now.

Use text editors (like: nano, vi etc.) to open the file locate at ```~/anaconda3/envs/vcf-kit/lib/python3.7/site-packages/vcfkit/utils/primer3.py```.
In this python script, find 'class primer3'. Under \# Global default, there is a block of script:
```python
       # Global default
        thermo_paths = ["/usr/local/share/primer3_config/",
                        "/usr/local/share/primer3/primer3_config/",
                        "~/.linuxbrew/share/primer3_config/",
                        "~/.linuxbrew/share/primer3/primer3_config/",
                        "/.linuxbrew/share/primer3_config/",
                        "/.linuxbrew/share/primer3/primer3_config/",
                        primer3_config]
```
Add our saved path to this default constant. Completed one will look like:
```python
        # Global default
        thermo_paths = ["/usr/local/share/primer3_config/",
                        "/usr/local/share/primer3/primer3_config/",
                        "~/.linuxbrew/share/primer3_config/",
                        "~/.linuxbrew/share/primer3/primer3_config/",
                        "/.linuxbrew/share/primer3_config/",
                        "/.linuxbrew/share/primer3/primer3_config/",
                        "~/anaconda3/lib/python3.6/site-packages/vcfkit/static/primer3_config",
                        primer3_config]
```
Now, we have finished enviroment settings for VCF-kit primer function.

## VCF preparation
VCF is a standard file type for variants calling containing basical information of polymorphic sites in population.
It can be generated from multiple softwares. In our lab, we use GATK 4.0 to call genotypes and filter the vcf file.
For further information of .vcf file type please refer to [Variant Call Format](https://gatk.broadinstitute.org/hc/en-us/articles/360035531692-VCF-Variant-Call-Format).

VCF-kit reads contig/chromosome length by reading the tag of sequence ID in vcf files. However, vcf files generated by GATK having the reference genome file name after
the sequence length, which will be incorrectly read as length variants so that causing an error. Before we run the command, those tags should be fixed.
Assuming our vcf file name is ```SE.parent.vcf```:
```bash
sed 's/,assembly=Salix_purpurea_var_94006.mainGenome.fasta//g' SE.parent.vcf > SE.parent.fixedname.vcf
```
Since we use Salix purpurea as our reference genome, the replacement regular expression is like above. 
If using different reference genomes or different file names, it is necessary to check the ID tags by ```grep "##contig=" SE.parent.vcf``` before replacing and replace exact everything between ```length=<Number>``` and the last ```>```.

When finishing replacing, we need to compress the file into .gz format for VCF-kit as an input. There is no need to index the new vcf file since the software will do it if there is no index.
```bash
bgzip -c SE.parent.fixedname.vcf > SE.parent.fixedname.vcf.gz
```
The output file is in the right format for VCF-kit to use.

## Output a table of primers related to polymorphic restriction site
The software package VCF-kit offers a function named 'primer snip' mode. It takes vcf file as input and output a table of primers designed based on polymorphic restriction sites in between. [Official manual](https://vcf-kit.readthedocs.io/en/latest/primer/) has the detailed parameter settings and examples.

To test if software works appropriately, we can do simple try on command prompt:
```bash
vk primer snip --ref=<reference genome fasta> --enzymes=EcoRI <vcf.gz of target population>
```
Let the software run for 1 min to see if any errors reported there. If the software runs and keep producing 'Applied N individuals', it means software works perfectly. We can use Ctrl-C to stop it.

We want our result to be stored in a text file. In order to do so, we need to write the command in a shell script and execute it to save the output.
```bash
echo "vk primer snip --ref=<reference genome fasta> \
                     --box-variants \
                     --polymorphic \
                     --enzymes=<your choice of restriction enzyme> \
                     <vcf.gz of target population>" > species1.enzyme1.sh
# execute the script and set the outputfile
sh species1.enzyme1.sh > species1.enzyme1.primer.txt
```
The software works slow for whole genome size. To run it at this size of data, personally I suggest to use ```screen -S <screen name>``` to create a new screen, ```screen -r <screen name>``` and Ctrl-A + Ctrl-D for reattaching and detaching existing screens, respectively. Another way to avoid long-time waiting is to limit the range of searching for primers by adding parameter ```--region``` to command we use here.

The output file is a tab-spaced table which looks like below:
CHROM | POS     | region            | REF | ALT | template_sample | variant_count | ref_sites           | alt_sites                   | restriction_enzyme | restriction_site | restriction_site_length | primer_left          | primer_right         | melting_temperature | amplicon_length | amplicon_region   | amplicon_sequence | 0/0 | 1/1 | polymorphic |
-------|---------|-------------------|-----|-----|-----------------|---------------|---------------------|-----------------------------|--------------------|------------------|-------------------------|----------------------|----------------------|---------------------|-----------------|-------------------|-------------------|-----|-------|-------------|
 I     | 1198228 | I:1197728-1198727 | G   | A   | ALT             | 1             | 93,283:93,190,471   | 93:93,661                   | NdeI               | CATATG           | 6                       | gtattcagtgggcaagcagc | GGATTAGGCCACCATCCGAG | 59.547,59.965       | 754             | I:1197943-1198697 | gtatt…            |     |       | FALSE       |
 I     | 1487691 | I:1487191-1488190 | A   | C   | ALT             | 1             | 548,654:548,106,100 | 356,548,654:356,192,106,100 | BsuRI              | GGCC             | 4                       | TCAAAGCTGTTTTTGGCGGG | CTTCCCGACAACTTTGCTGC | 59.896,60.04        | 754             | I:1487335-1488089 | TCAAA…            |     |       | FALSE       |
 I     | 1487691 | I:1487191-1488190 | A   | C   | ALT             | 1             | 548,654:548,106,100 | 356,548,654:356,192,106,100 | BsnI               | GGCC             | 4                       | TCAAAGCTGTTTTTGGCGGG | CTTCCCGACAACTTTGCTGC | 59.896,60.04        | 754             | I:1487335-1488089 | TCAAA…            |     |       | FALSE       |


